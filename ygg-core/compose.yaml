# %YAML 1.2
# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json  # yamllint disable-line
---
# version: "3.9"
name: ygg-core

networks:
  macvlan1:
    external: true

x-common: &common
  dns:
    - 10.4.21.34
    - 1.1.1.1
  dns_search: int.tnt.photo
  restart: "no"
  stop_grace_period: 2m

x-env: &env
  TZ: Etc/UTC

x-tz: &tz /usr/share/zoneinfo/Etc/UTC:/etc/localtime:ro

services:
  cloudflared:
    <<: *common
    command: tunnel run
    container_name: cloudflared
    cpu_count: 1
    deploy:
      resources:
        limits:
          # cpus: "1"
          memory: 128M
    env_file: cloudflared.txt
    environment:
      <<: *env
    hostname: cloudflared
    image: "docker.io/cloudflare/cloudflared:latest"
    mac_address: "0e:be:00:da:00:37"
    networks:
      macvlan1:
        ipv4_address: 10.4.21.37
    sysctls:
      net.ipv4.ip_local_port_range: "11000 60999"
    ulimits:
      nofile:
        soft: 70000
        hard: 70000
    volumes:
      - *tz

  dns:
    <<: *common
    container_name: dns
    cpu_count: 1
    deploy:
      resources:
        limits:
          # cpus: "1"
          memory: 1024M
        reservations:
          # cpus: "0.002"
          memory: 256M
    environment:
      <<: *env
      DNS_SERVER_DOMAIN: dns
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 10s
      test:
        [
          "CMD-SHELL",
          'grep -i "$(printf ''%08x:%04x'' 0 53)" /proc/net/udp >/dev/null 2>&1 || exit 1',
        ]
      timeout: 5s
    hostname: dns
    image: "docker.io/technitium/dns-server:latest"
    mac_address: "0e:be:00:da:00:34"
    networks:
      macvlan1:
        ipv4_address: 10.4.21.34
    sysctls:
      net.ipv4.ip_local_port_range: "1024 65000"
    volumes:
      - *tz
      - "/volume2/docker/dns:/etc/dns"
      - "/volume2/docker/acmesh/tnt.photo_ecc/tnt.photo.pfx:/etc/dns/tnt.photo.pfx"

  traefik:
    <<: *common
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--log.level=DEBUG"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0"
      - "--providers.docker=true"
      - "--providers.docker.watch"
    container_name: traefik
    cpu_count: 1
    deploy:
      resources:
        limits:
          # cpus: "1"
          memory: 256M
    environment:
      <<: *env
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 30s
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080"]
      timeout: 5s
    hostname: traefik
    image: "docker.io/library/traefik:v3"
    mac_address: "0e:be:00:da:00:44"
    networks:
      macvlan1:
        ipv4_address: 10.4.21.44
    volumes:
      - *tz
      - "/volume2/docker/traefik/dynamic.yml:/etc/traefik/dynamic.yml"
      - "/volume2/docker/traefik/traefik.yml:/etc/traefik/traefik.yml"
      - "/volume2/docker/acmesh/tnt.photo_ecc/:/certs:ro"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
